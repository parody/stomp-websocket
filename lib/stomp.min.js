// Generated by CoffeeScript 1.12.7
/*
   Stomp Over WebSocket http://www.jmesnil.net/stomp-websocket/doc/ | Apache License V2.0

   Copyright (C) 2010-2013 [Jeff Mesnil](http://jmesnil.net/)
   Copyright (C) 2012 [FuseSource, Inc.](http://fusesource.com)
 */
(function(){var w,r,m,u,o={}.hasOwnProperty,s=[].slice;w={LF:"\n",NULL:"\0"};m=function(){var s;function y(t,e,n){this.command=t;this.headers=e!=null?e:{};this.body=n!=null?n:""}y.prototype.toString=function(){var t,e,n,i,r;t=[this.command];i=this.headers["content-length"]===false?true:false;if(i){delete this.headers["content-length"]}n=this.headers;for(e in n){if(!o.call(n,e))continue;r=n[e];t.push(e+":"+r)}if(this.body&&!i){t.push("content-length:"+y.sizeOfUTF8(this.body))}t.push(w.LF+this.body);return t.join(w.LF)};y.sizeOfUTF8=function(t){if(t){return encodeURI(t).match(/%..|./g).length}else{return 0}};s=function(t){var e,n,i,r,o,s,u,a,c,f,h,l,p,d,g,b,m,v;r=t.search(RegExp(""+w.LF+w.LF));o=t.substring(0,r).split(w.LF);i=o.shift();s={};v=function(t){return t.replace(/^\s+|\s+$/g,"")};d=o.reverse();for(c=0,l=d.length;c<l;c++){p=d[c];a=p.indexOf(":");s[v(p.substring(0,a))]=v(p.substring(a+1))}e="";m=r+2;if(s["content-length"]){h=parseInt(s["content-length"]);e=(""+t).substring(m,m+h)}else{n=null;for(u=f=g=m,b=t.length;g<=b?f<b:f>b;u=g<=b?++f:--f){n=t.charAt(u);if(n===w.NULL){break}e+=n}}return new y(i,s,e)};y.unmarshall=function(t){var r,o,e,n;o=t.split(RegExp(""+w.NULL+w.LF+"*"));n={frames:[],partial:""};n.frames=function(){var t,e,n,i;n=o.slice(0,-1);i=[];for(t=0,e=n.length;t<e;t++){r=n[t];i.push(s(r))}return i}();e=o.slice(-1)[0];if(e===w.LF||e.search(RegExp(""+w.NULL+w.LF+"*$"))!==-1){n.frames.push(s(e))}else{n.partial=e}return n};y.marshall=function(t,e,n){var i;i=new y(t,e,n);return i.toString()+w.NULL};return y}();r=function(){var b;function t(t){this.ws=t;this.ws.binaryType="arraybuffer";this.counter=0;this.connected=false;this.heartbeat={outgoing:1e4,incoming:1e4};this.maxWebSocketFrameSize=16*1024;this.subscriptions={};this.partialData=""}t.prototype.debug=function(t){var e;return typeof window!=="undefined"&&window!==null?(e=window.console)!=null?e.log(t):void 0:void 0};b=function(){if(Date.now){return Date.now()}else{return(new Date).valueOf}};t.prototype._transmit=function(t,e,n){var i;i=m.marshall(t,e,n);if(typeof this.debug==="function"){this.debug(">>> "+i)}while(true){if(i.length>this.maxWebSocketFrameSize){this.ws.send(i.substring(0,this.maxWebSocketFrameSize));i=i.substring(this.maxWebSocketFrameSize);if(typeof this.debug==="function"){this.debug("remaining = "+i.length)}}else{return this.ws.send(i)}}};t.prototype._setupHeartbeat=function(r){var t,e,n,i,o,s;if((t=r.version)!==u.VERSIONS.V1_1&&t!==u.VERSIONS.V1_2){return}e=function(){var t,e,n,i;n=r["heart-beat"].split(",");i=[];for(t=0,e=n.length;t<e;t++){s=n[t];i.push(parseInt(s))}return i}(),i=e[0],n=e[1];if(!(this.heartbeat.outgoing===0||n===0)){o=Math.max(this.heartbeat.outgoing,n);if(typeof this.debug==="function"){this.debug("send PING every "+o+"ms")}this.pinger=u.setInterval(o,function(t){return function(){t.ws.send(w.LF);return typeof t.debug==="function"?t.debug(">>> PING"):void 0}}(this))}if(!(this.heartbeat.incoming===0||i===0)){o=Math.max(this.heartbeat.incoming,i);if(typeof this.debug==="function"){this.debug("check PONG every "+o+"ms")}return this.ponger=u.setInterval(o,function(e){return function(){var t;t=b()-e.serverActivity;if(t>o*2){if(typeof e.debug==="function"){e.debug("did not receive server activity for the last "+t+"ms")}return e.ws.close()}}}(this))}};t.prototype._parseConnect=function(){var t,e,n,i;t=1<=arguments.length?s.call(arguments,0):[];i={};switch(t.length){case 2:i=t[0],e=t[1];break;case 3:if(t[1]instanceof Function){i=t[0],e=t[1],n=t[2]}else{i.login=t[0],i.passcode=t[1],e=t[2]}break;case 4:i.login=t[0],i.passcode=t[1],e=t[2],n=t[3];break;default:i.login=t[0],i.passcode=t[1],e=t[2],n=t[3],i.host=t[4]}return[i,e,n]};t.prototype.connect=function(){var t,g,e,n;t=1<=arguments.length?s.call(arguments,0):[];n=this._parseConnect.apply(this,t);e=n[0],this.connectCallback=n[1],g=n[2];if(typeof this.debug==="function"){this.debug("Opening Web Socket...")}this.ws.onmessage=function(d){return function(t){var i,r,e,n,o,s,u,a,c,f,h,l,p;n=typeof ArrayBuffer!=="undefined"&&t.data instanceof ArrayBuffer?(i=new Uint8Array(t.data),typeof d.debug==="function"?d.debug("--- got data length: "+i.length):void 0,function(){var t,e,n;n=[];for(t=0,e=i.length;t<e;t++){r=i[t];n.push(String.fromCharCode(r))}return n}().join("")):t.data;d.serverActivity=b();if(n===w.LF){if(typeof d.debug==="function"){d.debug("<<< PONG")}return}if(typeof d.debug==="function"){d.debug("<<< "+n)}p=m.unmarshall(d.partialData+n);d.partialData=p.partial;f=p.frames;h=[];for(s=0,u=f.length;s<u;s++){o=f[s];switch(o.command){case"CONNECTED":if(typeof d.debug==="function"){d.debug("connected to server "+o.headers.server)}d.connected=true;d._setupHeartbeat(o.headers);h.push(typeof d.connectCallback==="function"?d.connectCallback(o):void 0);break;case"MESSAGE":l=o.headers.subscription;c=d.subscriptions[l]||d.onreceive;if(c){e=d;a=o.headers["message-id"];o.ack=function(t){if(t==null){t={}}return e.ack(a,l,t)};o.nack=function(t){if(t==null){t={}}return e.nack(a,l,t)};h.push(c(o))}else{h.push(typeof d.debug==="function"?d.debug("Unhandled received MESSAGE: "+o):void 0)}break;case"RECEIPT":h.push(typeof d.onreceipt==="function"?d.onreceipt(o):void 0);break;case"ERROR":h.push(typeof g==="function"?g(o):void 0);break;default:h.push(typeof d.debug==="function"?d.debug("Unhandled frame: "+o):void 0)}}return h}}(this);this.ws.onclose=function(e){return function(){var t;t="Whoops! Lost connection to "+e.ws.url;if(typeof e.debug==="function"){e.debug(t)}e._cleanUp();return typeof g==="function"?g(t):void 0}}(this);return this.ws.onopen=function(t){return function(){if(typeof t.debug==="function"){t.debug("Web Socket Opened...")}e["accept-version"]=u.VERSIONS.supportedVersions();e["heart-beat"]=[t.heartbeat.outgoing,t.heartbeat.incoming].join(",");return t._transmit("CONNECT",e)}}(this)};t.prototype.disconnect=function(t,e){if(e==null){e={}}this._transmit("DISCONNECT",e);this.ws.onclose=null;this.ws.close();this._cleanUp();return typeof t==="function"?t():void 0};t.prototype._cleanUp=function(){this.connected=false;if(this.pinger){u.clearInterval(this.pinger)}if(this.ponger){return u.clearInterval(this.ponger)}};t.prototype.send=function(t,e,n){if(e==null){e={}}if(n==null){n=""}e.destination=t;return this._transmit("SEND",e,n)};t.prototype.subscribe=function(t,e,n){var i;if(n==null){n={}}if(!n.id){n.id="sub-"+this.counter++}n.destination=t;this.subscriptions[n.id]=e;this._transmit("SUBSCRIBE",n);i=this;return{id:n.id,unsubscribe:function(){return i.unsubscribe(n.id)}}};t.prototype.unsubscribe=function(t){delete this.subscriptions[t];return this._transmit("UNSUBSCRIBE",{id:t})};t.prototype.begin=function(t){var e,n;n=t||"tx-"+this.counter++;this._transmit("BEGIN",{transaction:n});e=this;return{id:n,commit:function(){return e.commit(n)},abort:function(){return e.abort(n)}}};t.prototype.commit=function(t){return this._transmit("COMMIT",{transaction:t})};t.prototype.abort=function(t){return this._transmit("ABORT",{transaction:t})};t.prototype.ack=function(t,e,n){if(n==null){n={}}n["message-id"]=t;n.subscription=e;return this._transmit("ACK",n)};t.prototype.nack=function(t,e,n){if(n==null){n={}}n["message-id"]=t;n.subscription=e;return this._transmit("NACK",n)};return t}();u={VERSIONS:{V1_0:"1.0",V1_1:"1.1",V1_2:"1.2",supportedVersions:function(){return"1.1,1.0"}},client:function(t,e){var n,i;if(e==null){e=["v10.stomp","v11.stomp"]}n=u.WebSocketClass||WebSocket;i=new n(t,e);return new r(i)},over:function(t){return new r(t)},Frame:m};if(typeof exports!=="undefined"&&exports!==null){exports.Stomp=u}if(typeof window!=="undefined"&&window!==null){u.setInterval=function(t,e){return window.setInterval(e,t)};u.clearInterval=function(t){return window.clearInterval(t)};window.Stomp=u}else if(!exports){self.Stomp=u}}).call(this);